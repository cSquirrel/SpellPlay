# PR validation: build, unit tests, UI tests (no Xcode Cloud).
# Satisfies: run unit/UI tests on every PR with status checks on GitHub.
# Branch protection: require build + unit-tests + ui-tests (or this workflow) after first successful run.
# Pinned to latest macOS runner and Xcode (update periodically; see actions/runner-images).
# Unit and UI tests run in parallel after the build.
name: PR Validation

on:
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build
    runs-on: macos-15  # Latest macOS runner (macOS 15.x)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "26.2"  # Latest stable Xcode on macos-15

      - name: Build for testing
        run: |
          xcodebuild build-for-testing \
            -project SpellPlay.xcodeproj \
            -scheme SpellPlay \
            -sdk iphonesimulator \
            -destination 'generic/platform=iOS Simulator' \
            -derivedDataPath ./DerivedData

      - name: Upload test build
        uses: actions/upload-artifact@v4
        with:
          name: test-build
          path: DerivedData/Build/Products

  unit-tests:
    name: Unit tests
    needs: [build]
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "26.2"

      - name: Download test build
        uses: actions/download-artifact@v4
        with:
          name: test-build

      - name: Run unit tests
        run: |
          XCTESTRUN=$(find ./DerivedData/Build/Products -name '*.xctestrun' | head -1)
          echo "Using xctestrun: $XCTESTRUN"
          xcodebuild test-without-building \
            -xctestrun "$XCTESTRUN" \
            -destination 'platform=iOS Simulator,name=iPhone 17 Pro Max' \
            -only-testing:SpellPlayTests

  ui-tests:
    name: UI tests
    needs: [build]
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "26.2"

      - name: Download test build
        uses: actions/download-artifact@v4
        with:
          name: test-build

      - name: Run UI tests
        run: |
          XCTESTRUN=$(find ./DerivedData/Build/Products -name '*.xctestrun' | head -1)
          echo "Using xctestrun: $XCTESTRUN"
          xcodebuild test-without-building \
            -xctestrun "$XCTESTRUN" \
            -destination 'platform=iOS Simulator,name=iPhone 17 Pro Max' \
            -only-testing:SpellPlayUITests
